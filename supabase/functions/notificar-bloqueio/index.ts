import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

const DELAY_ENTRE_MENSAGENS = 2000; // 2 segundos para n√£o sobrecarregar Evolution API

// Fun√ß√£o para formatar celular no padr√£o internacional brasileiro
function formatarCelular(celular: string): string | null {
  if (!celular) return null;
  
  // Remove todos os caracteres n√£o num√©ricos
  const numero = celular.replace(/\D/g, '');
  
  // Valida formato brasileiro (11 d√≠gitos: DDD + 9 d√≠gitos)
  if (numero.length !== 11) {
    console.warn(`‚ö†Ô∏è Celular inv√°lido (${numero.length} d√≠gitos): ${celular}`);
    return null;
  }
  
  // Valida DDD (deve estar entre 11 e 99)
  const ddd = parseInt(numero.substring(0, 2));
  if (ddd < 11 || ddd > 99) {
    console.warn(`‚ö†Ô∏è DDD inv√°lido: ${ddd}`);
    return null;
  }
  
  // Retorna no formato internacional: 55 + DDD + n√∫mero
  return `55${numero}`;
}

// Fun√ß√£o para formatar data no padr√£o brasileiro
function formatarData(data: string): string {
  const [ano, mes, dia] = data.split('-');
  return `${dia}/${mes}/${ano}`;
}

// Fun√ß√£o para formatar hora removendo segundos
function formatarHora(hora: string): string {
  return hora.substring(0, 5); // "08:00:00" -> "08:00"
}

// Fun√ß√£o para criar mensagem de bloqueio COM pr√≥ximas datas
function criarMensagemComDatas(params: {
  pacienteNome: string;
  medicoNome: string;
  dataOriginal: string;
  horaOriginal: string;
  motivo: string;
  proximasDatas: Array<{data: string; dia_semana: string; horarios: string[]}>;
}): string {
  const { pacienteNome, medicoNome, dataOriginal, horaOriginal, motivo, proximasDatas } = params;
  
  let mensagem = `üö® IMPORTANTE: Reagendamento Necess√°rio\n\n`;
  mensagem += `Ol√°, ${pacienteNome}!\n\n`;
  mensagem += `Sua consulta com ${medicoNome} no dia ${formatarData(dataOriginal)} √†s ${formatarHora(horaOriginal)}h foi cancelada.\n\n`;
  mensagem += `üìã Motivo: ${motivo}\n\n`;
  mensagem += `‚úÖ PR√ìXIMAS DATAS DISPON√çVEIS:\n\n`;
  
  proximasDatas.slice(0, 3).forEach((disponibilidade) => {
    mensagem += `üìÖ ${formatarData(disponibilidade.data)} - ${disponibilidade.dia_semana}\n`;
    mensagem += `üïê ${disponibilidade.horarios.slice(0, 3).join(' | ')}\n\n`;
  });
  
  mensagem += `Para reagendar, responda este WhatsApp ou ligue:\n`;
  mensagem += `üìû (19) 3442-8053\n\n`;
  mensagem += `Cl√≠nica INOVAIA - IPADO`;
  
  return mensagem;
}

// Fun√ß√£o para criar mensagem de bloqueio SEM pr√≥ximas datas (fallback)
function criarMensagemSemDatas(params: {
  pacienteNome: string;
  medicoNome: string;
  dataOriginal: string;
  horaOriginal: string;
  motivo: string;
}): string {
  const { pacienteNome, medicoNome, dataOriginal, horaOriginal, motivo } = params;
  
  let mensagem = `üö® IMPORTANTE: Reagendamento Necess√°rio\n\n`;
  mensagem += `Ol√°, ${pacienteNome}!\n\n`;
  mensagem += `Sua consulta com ${medicoNome} no dia ${formatarData(dataOriginal)} √†s ${formatarHora(horaOriginal)}h foi cancelada.\n\n`;
  mensagem += `üìã Motivo: ${motivo}\n\n`;
  mensagem += `‚ö†Ô∏è No momento n√£o h√° vagas dispon√≠veis na agenda online.\n\n`;
  mensagem += `Por favor, entre em contato para reagendar:\n`;
  mensagem += `üìû (19) 3442-8053\n\n`;
  mensagem += `Cl√≠nica INOVAIA - IPADO`;
  
  return mensagem;
}

// Fun√ß√£o para enviar WhatsApp via Evolution API
async function enviarWhatsApp(celular: string, mensagem: string) {
  const evolutionUrl = Deno.env.get('EVOLUTION_API_URL') || 'https://evolutionapi.inovaia.online';
  const apiKey = Deno.env.get('EVOLUTION_API_KEY') || 'grozNCsxwy32iYir20LRw7dfIRNPI8UZ';
  const instanceName = Deno.env.get('EVOLUTION_INSTANCE_NAME') || 'Endogastro';
  
  console.log(`üì± Enviando WhatsApp para: ${celular}`);
  
  const response = await fetch(`${evolutionUrl}/message/sendText/${instanceName}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'apikey': apiKey
    },
    body: JSON.stringify({
      number: celular,
      text: mensagem
    })
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Evolution API error ${response.status}: ${errorText}`);
  }
  
  return await response.json();
}

serve(async (req) => {
  console.log('üöÄ NOTIFICAR BLOQUEIO - Iniciando');
  
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }
  
  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
    
    if (!supabaseUrl || !supabaseServiceKey) {
      throw new Error('Configura√ß√£o Supabase incompleta');
    }
    
    const supabase = createClient(supabaseUrl, supabaseServiceKey);
    
    // Receber dados do bloqueio
    const { 
      medico_id, 
      medico_nome, 
      data_inicio, 
      data_fim, 
      motivo,
      agendamentos_afetados 
    } = await req.json();
    
    console.log(`üìã Bloqueio criado: ${medico_nome} (${data_inicio} a ${data_fim})`);
    console.log(`üë• Agendamentos afetados: ${agendamentos_afetados}`);
    
    // Buscar agendamentos cancelados por este bloqueio com dados dos pacientes
    const { data: agendamentos, error: agendamentosError } = await supabase
      .from('agendamentos')
      .select(`
        id,
        data_agendamento,
        hora_agendamento,
        atendimento_id,
        pacientes!inner(
          id,
          nome_completo,
          celular,
          telefone
        ),
        atendimentos!inner(
          id,
          nome
        )
      `)
      .eq('medico_id', medico_id)
      .gte('data_agendamento', data_inicio)
      .lte('data_agendamento', data_fim)
      .eq('status', 'cancelado_bloqueio');
    
    if (agendamentosError) {
      throw new Error(`Erro ao buscar agendamentos: ${agendamentosError.message}`);
    }
    
    if (!agendamentos || agendamentos.length === 0) {
      console.log('‚úÖ Nenhum agendamento com paciente encontrado');
      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Nenhuma notifica√ß√£o necess√°ria',
          notificacoes_enviadas: 0
        }),
        { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
    
    console.log(`üì§ Processando ${agendamentos.length} notifica√ß√µes...`);
    
    const resultados = {
      total: agendamentos.length,
      enviados: 0,
      erros: 0,
      pulados: 0,
      detalhes: [] as Array<{paciente: string; status: string; motivo?: string}>
    };
    
    // Processar cada agendamento com rate limiting
    for (let i = 0; i < agendamentos.length; i++) {
      const agendamento = agendamentos[i];
      const paciente = agendamento.pacientes;
      const atendimento = agendamento.atendimentos;
      
      console.log(`\nüìç [${i + 1}/${agendamentos.length}] Processando: ${paciente.nome_completo}`);
      
      // Validar e formatar celular
      const celularFormatado = formatarCelular(paciente.celular || paciente.telefone);
      
      if (!celularFormatado) {
        console.warn(`‚ö†Ô∏è Paciente sem celular v√°lido: ${paciente.nome_completo}`);
        resultados.pulados++;
        resultados.detalhes.push({
          paciente: paciente.nome_completo,
          status: 'pulado',
          motivo: 'Celular inv√°lido ou ausente'
        });
        continue;
      }
      
      try {
        // Buscar pr√≥ximas datas dispon√≠veis via LLM Agent API
        console.log(`üîç Buscando pr√≥ximas datas para ${atendimento.nome}...`);
        
        const { data: disponibilidade, error: llmError } = await supabase.functions.invoke('llm-agent-api', {
          body: {
            action: 'availability',
            medico_nome: medico_nome,
            atendimento_nome: atendimento.nome,
            buscar_proximas: true,
            quantidade_dias: 14 // Buscar nas pr√≥ximas 2 semanas
          }
        });
        
        let mensagem: string;
        
        if (llmError || !disponibilidade?.proximas_datas || disponibilidade.proximas_datas.length === 0) {
          console.warn(`‚ö†Ô∏è Sem datas dispon√≠veis - usando mensagem fallback`);
          // Mensagem sem sugest√£o de datas
          mensagem = criarMensagemSemDatas({
            pacienteNome: paciente.nome_completo,
            medicoNome: medico_nome,
            dataOriginal: agendamento.data_agendamento,
            horaOriginal: agendamento.hora_agendamento,
            motivo: motivo
          });
        } else {
          console.log(`‚úÖ ${disponibilidade.proximas_datas.length} datas encontradas`);
          // Mensagem com sugest√£o de datas
          mensagem = criarMensagemComDatas({
            pacienteNome: paciente.nome_completo,
            medicoNome: medico_nome,
            dataOriginal: agendamento.data_agendamento,
            horaOriginal: agendamento.hora_agendamento,
            motivo: motivo,
            proximasDatas: disponibilidade.proximas_datas
          });
        }
        
        // Enviar WhatsApp
        const whatsappResult = await enviarWhatsApp(celularFormatado, mensagem);
        console.log(`‚úÖ WhatsApp enviado: ${paciente.nome_completo}`);
        
        // Registrar notifica√ß√£o no banco
        await supabase.from('notificacoes_enviadas').insert({
          agendamento_id: agendamento.id,
          paciente_id: paciente.id,
          tipo: 'bloqueio_agenda',
          mensagem: mensagem,
          celular: celularFormatado,
          status: 'enviado',
          cliente_id: '2bfb98b5-ae41-4f96-8ba7-acc797c22054' // IPADO
        });
        
        resultados.enviados++;
        resultados.detalhes.push({
          paciente: paciente.nome_completo,
          status: 'enviado'
        });
        
        // Rate limiting: aguardar antes do pr√≥ximo envio
        if (i < agendamentos.length - 1) {
          console.log(`‚è≥ Aguardando ${DELAY_ENTRE_MENSAGENS}ms...`);
          await new Promise(resolve => setTimeout(resolve, DELAY_ENTRE_MENSAGENS));
        }
        
      } catch (error: any) {
        console.error(`‚ùå Erro ao processar ${paciente.nome_completo}:`, error.message);
        
        // Registrar erro no banco
        await supabase.from('notificacoes_enviadas').insert({
          agendamento_id: agendamento.id,
          paciente_id: paciente.id,
          tipo: 'bloqueio_agenda',
          mensagem: 'Erro no envio',
          celular: celularFormatado,
          status: 'erro',
          erro: error.message,
          tentativas: 1,
          cliente_id: '2bfb98b5-ae41-4f96-8ba7-acc797c22054'
        });
        
        resultados.erros++;
        resultados.detalhes.push({
          paciente: paciente.nome_completo,
          status: 'erro',
          motivo: error.message
        });
      }
    }
    
    console.log('\nüìä RESUMO FINAL:');
    console.log(`‚úÖ Enviados: ${resultados.enviados}`);
    console.log(`‚ùå Erros: ${resultados.erros}`);
    console.log(`‚ö†Ô∏è Pulados: ${resultados.pulados}`);
    
    // Log do processo completo
    await supabase.from('system_logs').insert({
      timestamp: new Date().toISOString(),
      level: 'info',
      message: `Notifica√ß√µes de bloqueio processadas: ${resultados.enviados}/${resultados.total} enviadas`,
      context: 'NOTIFICAR_BLOQUEIO',
      data: {
        medico: medico_nome,
        periodo: `${data_inicio} a ${data_fim}`,
        motivo: motivo,
        resultados: resultados
      }
    });
    
    return new Response(
      JSON.stringify({ 
        success: true,
        message: `Notifica√ß√µes processadas: ${resultados.enviados} enviadas, ${resultados.erros} erros, ${resultados.pulados} pulados`,
        resultados: resultados
      }),
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
    
  } catch (error: any) {
    console.error('‚ùå ERRO GERAL:', error);
    return new Response(
      JSON.stringify({ 
        success: false, 
        error: error.message 
      }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
